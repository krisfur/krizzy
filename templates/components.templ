package templates

import (
	"krizzy/internal/models"
	"fmt"
)

func isPersonAssigned(personID int64, assignees []models.Person) bool {
	for _, a := range assignees {
		if a.ID == personID {
			return true
		}
	}
	return false
}

templ AssigneePicker(cardID int64, assignees []models.Person, allPeople []models.Person) {
	<div>
		<h3 class="text-sm font-medium text-dark-300 mb-2">Assignees</h3>
		if len(allPeople) == 0 {
			<p class="text-dark-400 text-sm">No people available. Add people using the "Manage People" button.</p>
		} else {
			<form
				hx-post={ fmt.Sprintf("/cards/%d/assignees", cardID) }
				hx-target="#assignee-picker"
				hx-swap="innerHTML"
			>
				<div class="flex flex-wrap gap-2 mb-2">
					for _, person := range allPeople {
						<label class="flex items-center gap-2 cursor-pointer">
							if isPersonAssigned(person.ID, assignees) {
								<input
									type="checkbox"
									name="person_ids"
									value={ fmt.Sprintf("%d", person.ID) }
									checked
									class="rounded border-dark-500 bg-dark-700 text-go-blue focus:ring-go-blue"
								/>
							} else {
								<input
									type="checkbox"
									name="person_ids"
									value={ fmt.Sprintf("%d", person.ID) }
									class="rounded border-dark-500 bg-dark-700 text-go-blue focus:ring-go-blue"
								/>
							}
							<span class="text-sm text-dark-200">{ person.Name }</span>
						</label>
					}
				</div>
				<button
					type="submit"
					class="px-3 py-1 bg-go-blue text-white rounded hover:bg-go-blue-dark text-sm font-medium"
				>
					Update Assignees
				</button>
			</form>
		}
		if len(assignees) > 0 {
			<div class="mt-3">
				<span class="text-xs text-dark-400">Currently assigned:</span>
				<div class="flex gap-1 mt-1 flex-wrap">
					for _, assignee := range assignees {
						<span class="text-xs bg-go-blue bg-opacity-20 text-go-blue px-2 py-0.5 rounded-full border border-go-blue border-opacity-30">
							{ assignee.Name }
						</span>
					}
				</div>
			</div>
		}
	</div>
}

templ ChecklistComponent(cardID int64, items []models.ChecklistItem) {
	<div>
		<h3 class="text-sm font-medium text-dark-300 mb-2">Checklist</h3>
		if len(items) > 0 {
			@checklistProgressBar(items)
		}
		<div class="space-y-2 mb-3 checklist-container" data-card-id={ fmt.Sprintf("%d", cardID) }>
			for _, item := range items {
				@checklistItemComponent(&item)
			}
		</div>
		<form
			hx-post={ fmt.Sprintf("/cards/%d/checklist", cardID) }
			hx-target="#checklist-section"
			hx-swap="innerHTML"
			hx-on::after-request="this.reset()"
			class="flex gap-2"
		>
			<input
				type="text"
				name="content"
				placeholder="Add checklist item..."
				class="flex-1 px-3 py-2 border border-dark-600 rounded-md bg-dark-700 text-dark-100 placeholder-dark-400 focus:outline-none focus:ring-2 focus:ring-go-blue focus:border-transparent text-sm"
				required
			/>
			<button
				type="submit"
				class="px-3 py-2 bg-go-blue text-white rounded hover:bg-go-blue-dark text-sm font-medium"
			>
				Add
			</button>
		</form>
	</div>
}

templ checklistProgressBar(items []models.ChecklistItem) {
	{{
		completed := 0
		for _, item := range items {
			if item.IsCompleted {
				completed++
			}
		}
		percentage := (completed * 100) / len(items)
	}}
	<div class="mb-3">
		<div class="flex justify-between text-xs text-dark-400 mb-1">
			<span>Progress</span>
			<span>{ fmt.Sprintf("%d/%d", completed, len(items)) }</span>
		</div>
		<div class="w-full bg-dark-600 rounded-full h-2">
			<div
				class={ "h-2 rounded-full transition-all", templ.KV("bg-green-500", percentage == 100), templ.KV("bg-go-blue", percentage < 100) }
				style={ fmt.Sprintf("width: %d%%", percentage) }
			></div>
		</div>
	</div>
}

templ checklistItemComponent(item *models.ChecklistItem) {
	<div
		class="flex items-center gap-2 p-2 bg-dark-700 rounded checklist-item border border-dark-600"
		data-item-id={ fmt.Sprintf("%d", item.ID) }
	>
		<form
			hx-put={ fmt.Sprintf("/checklist/%d", item.ID) }
			hx-target="#checklist-section"
			hx-swap="innerHTML"
			hx-trigger="change"
			class="flex items-center gap-2 flex-1"
		>
			if item.IsCompleted {
				<input
					type="checkbox"
					name="is_completed"
					value="true"
					checked
					class="rounded border-dark-500 bg-dark-600 text-go-blue focus:ring-go-blue"
				/>
				<span class="text-sm text-dark-400 line-through flex-1">{ item.Content }</span>
			} else {
				<input
					type="checkbox"
					name="is_completed"
					value="true"
					class="rounded border-dark-500 bg-dark-600 text-go-blue focus:ring-go-blue"
				/>
				<span class="text-sm text-dark-200 flex-1">{ item.Content }</span>
			}
		</form>
		<button
			class="text-red-400 hover:text-red-300"
			hx-delete={ fmt.Sprintf("/checklist/%d", item.ID) }
			hx-target="#checklist-section"
			hx-swap="innerHTML"
		>
			<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
			</svg>
		</button>
	</div>
}

templ CommentsList(cardID int64, comments []models.Comment) {
	<div>
		<h3 class="text-sm font-medium text-dark-300 mb-2">Comments</h3>
		<form
			hx-post={ fmt.Sprintf("/cards/%d/comments", cardID) }
			hx-target="#comments-section"
			hx-swap="innerHTML"
			hx-on::after-request="this.reset()"
			class="mb-3"
		>
			<textarea
				name="content"
				rows="2"
				placeholder="Add a comment..."
				class="w-full px-3 py-2 border border-dark-600 rounded-md bg-dark-700 text-dark-100 placeholder-dark-400 focus:outline-none focus:ring-2 focus:ring-go-blue focus:border-transparent text-sm"
				required
			></textarea>
			<button
				type="submit"
				class="mt-1 px-3 py-1 bg-go-blue text-white rounded hover:bg-go-blue-dark text-sm font-medium"
			>
				Add Comment
			</button>
		</form>
		<div class="space-y-3">
			if len(comments) == 0 {
				<p class="text-dark-400 text-sm">No comments yet.</p>
			} else {
				for _, comment := range comments {
					@commentItemComponent(&comment)
				}
			}
		</div>
	</div>
}

templ commentItemComponent(comment *models.Comment) {
	<div class="p-3 bg-dark-700 rounded-lg border border-dark-600">
		<div class="flex justify-between items-start">
			<p class="text-sm text-dark-200 whitespace-pre-wrap">{ comment.Content }</p>
			<button
				class="text-red-400 hover:text-red-300 ml-2 flex-shrink-0"
				hx-delete={ fmt.Sprintf("/comments/%d", comment.ID) }
				hx-target="#comments-section"
				hx-swap="innerHTML"
				hx-confirm="Delete this comment?"
			>
				<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
				</svg>
			</button>
		</div>
		<p class="text-xs text-dark-500 mt-1">{ comment.CreatedAt.Format("Jan 2, 2006 at 3:04 PM") }</p>
	</div>
}
